service: |
  [Unit]
  Description=Run %{service_name}_1
  After=%{after}.service
  Requires=%{after}.service

  [Service]
  Restart=always
  RestartSec=10s
  ExecStartPre=/usr/bin/docker ps -a -q | xargs docker rm
  ExecStart=/usr/bin/docker run -rm -name %{service_name}_1 %{volumes.join(" ")} %{links.join(" ")} %{envs.join(" ")} %{ports.join(" ")} %{image}
  ExecStartPost=/usr/bin/docker ps -a -q | xargs docker rm
  ExecStop=/usr/bin/docker kill %{service_name}_1
  ExecStopPost=/usr/bin/docker ps -a -q | xargs docker rm

  [Install]
  WantedBy=local.target

discovery: |
  [Unit]
  Description=Announce %{service_name}_1
  BindsTo=%{service_name}.1.service

  [Service]
  ExecStart=/bin/sh -c "while true; do etcdctl set /services/%{service_name}/%{service_name}_1 '{ \\"host\\": \\"%H\\", %{port}\\"version\\": \\"52c7248a14\\" }' --ttl 60;sleep 45;done"
  ExecStop=/usr/bin/etcdctl rm /services/%{service_name}/%{service_name}_1

  [X-Fleet]
  X-ConditionMachineOf=%{service_name}.1.service
